<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥èµ„è®¡ç®—å™¨ï¼ˆå¸¦å†å²å›å¡«åŠŸèƒ½ï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        body {
            background: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .rule-card {
            background: #f0f8fb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #4299e1;
        }
        .rule-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .rule-card p {
            color: #4a5568;
            font-size: 14px;
            margin: 5px 0;
            line-height: 1.5;
        }
        .rule-card span {
            color: #e53e3e;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            color: #4a5568;
            font-weight: 500;
            font-size: 14px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        input.error {
            border-color: #e53e3e;
        }
        .rate-tag {
            background: #e8f4f8;
            color: #2d3748;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
            min-width: 120px;
            text-align: center;
        }
        .fixed-item {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 8px;
            margin: 25px 0;
        }
        .fixed-item h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .fixed-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .fixed-row:last-child {
            border-bottom: none;
        }
        .fixed-label {
            color: #4a5568;
            font-size: 14px;
        }
        .fixed-value {
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }
        .performance-status {
            color: #e53e3e;
            font-weight: 600;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        #calcBtn {
            background: #4299e1;
            color: white;
        }
        #calcBtn:hover {
            background: #3182ce;
        }
        #calcBtn:active {
            background: #2b6cb0;
        }
        #resetBtn {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        #resetBtn:hover {
            background: #edf2f7;
        }
        .result {
            margin: 20px 0;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 8px;
            text-align: center;
        }
        .result h2 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 18px;
        }
        #resultValue {
            font-size: 36px;
            font-weight: bold;
            color: #4299e1;
        }
        .copy-btn {
            padding: 8px 20px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
        }
        .copy-btn:hover {
            background: #38a169;
        }
        .history {
            margin-top: 30px;
        }
        .history h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 16px;
        }
        #historyList {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
        }
        /* ä¿®æ”¹åçš„å†å²è®°å½•æ ·å¼ */
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #f7fafc;
            font-size: 13px;
            cursor: pointer; /* é¼ æ ‡å˜æ‰‹å‹ */
            transition: all 0.2s;
            border-radius: 4px;
            position: relative;
        }
        .history-item:hover {
            background-color: #ebf8ff; /* æ‚¬åœé«˜äº® */
            border-left: 3px solid #4299e1;
            padding-left: 9px; /* ä¿æŒå†…å®¹ä½ç½®å¹³è¡¡ */
        }
        .history-item::after {
            content: 'ç‚¹å‡»æ¢å¤';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #4299e1;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .history-item:hover::after {
            opacity: 1;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .history-detail {
            color: #718096;
            line-height: 1.4;
        }
        #clearHistory {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #fef2f2;
            color: #e53e3e;
            border: 1px solid #fee2e2;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        #clearHistory:hover {
            background: #fed7d7;
        }
        .tip {
            font-size: 12px;
            color: #718096;
            margin-top: 15px;
            text-align: center;
        }
        /* ç¼ºå£è®¡ç®—æ ·å¼ */
        .gap-calculator {
            background: #fdf2f8;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 4px solid #9f7aea;
        }
        .gap-calculator h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gap-calculator h3 svg {
            width: 20px;
            height: 20px;
            fill: #9f7aea;
        }
        .gap-summary {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #4a5568;
        }
        .gap-summary span {
            color: #e53e3e;
            font-weight: 600;
        }
        .gap-success {
            color: #48bb78 !important;
        }
        .gap-items-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .gap-items-container {
                grid-template-columns: 1fr;
            }
        }
        .gap-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
        }
        .gap-item h4 {
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .gap-detail {
            font-size: 13px;
            color: #4a5568;
            line-height: 1.6;
        }
        .gap-number {
            color: #9f7aea;
            font-weight: 600;
        }
        .gap-tip {
            color: #718096;
            font-size: 12px;
            margin-top: 4px;
        }
        .error-tip {
            color: #e53e3e;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        /* è®¡ç®—çŠ¶æ€æç¤º */
        .calc-status {
            text-align: center;
            color: #4299e1;
            font-size: 14px;
            margin: 10px 0;
            display: none;
        }
        /* é€‚é…5ä¸ªè¾“å…¥é¡¹çš„å¸ƒå±€ */
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å·¥èµ„è®¡ç®—å™¨ï¼ˆç‚¹å‡»è®°å½•å¯å›å¡«ï¼‰</h1>

        <div class="rule-card">
            <h3>ğŸ“‹ å·¥èµ„è®¡ç®—è§„åˆ™ï¼ˆæœ€ç»ˆç¡®è®¤ï¼‰</h3>
            <p>1. ç»¼åˆè¾¾æˆç‡ = ä¸»æ¨40% + é”€å”®é¢30% + éæ‰‹æœº10% + DSR10% + DOS10%ï¼ˆ5é¡¹å‡<span>å°é¡¶130%</span>ï¼‰</p>
            <p>2. ç»©æ•ˆåŸºæ•° = åŸºæœ¬å·¥èµ„Ã—50%ï¼Œç»©æ•ˆå‘æ”¾ï¼š</p>
            <p>   - ç»¼åˆè¾¾æˆç‡ < 70%ï¼šæ— ç»©æ•ˆï¼ˆç»©æ•ˆ=0ï¼‰</p>
            <p>   - 70% â‰¤ ç»¼åˆè¾¾æˆç‡ < 100%ï¼šç»©æ•ˆ=ç»©æ•ˆåŸºæ•°Ã—ç»¼åˆè¾¾æˆç‡ï¼ˆå¦‚80%â†’Ã—0.8ï¼‰</p>
            <p>   - ç»¼åˆè¾¾æˆç‡ â‰¥ 100%ï¼šç»©æ•ˆ=ç»©æ•ˆåŸºæ•°Ã—<span>1.2å€</span>ï¼ˆå›ºå®šä¸Šæµ®20%ï¼‰</p>
            <p>3. æœ€ç»ˆå·¥èµ„ = åŸºæœ¬å·¥èµ„ + å®é™…ç»©æ•ˆ + é¤è¡¥ï¼ˆå›ºå®š695å…ƒï¼‰</p>
        </div>

        <div class="form-group">
            <label for="baseSalary">åŸºæœ¬å·¥èµ„ï¼ˆå…ƒï¼‰<span style="color: #e53e3e;">*</span></label>
            <input type="number" id="baseSalary" placeholder="è¯·è¾“å…¥åŸºæœ¬å·¥èµ„ï¼ˆå¦‚10000ï¼‰" min="1" step="1">
            <div class="error-tip" id="baseSalaryError">è¯·è¾“å…¥æœ‰æ•ˆçš„åŸºæœ¬å·¥èµ„ï¼ˆå¤§äº0ï¼‰</div>
        </div>

        <h3 style="color: #4a5568; font-size: 16px; margin: 20px 0 15px;">ä»»åŠ¡ç›®æ ‡ä¸å®é™…å®Œæˆï¼ˆå¡«å†™å³ç®—ç¼ºå£ï¼‰</h3>
        
        <div class="input-grid">
            <div class="form-group">
                <label>ä¸»æ¨ï¼ˆå æ¯”40%ï¼‰<span style="color: #e53e3e;">*</span></label>
                <div class="input-group">
                    <input type="number" id="mainPushTarget" placeholder="ä»»åŠ¡ç›®æ ‡" min="1" step="1">
                    <input type="number" id="mainPushActual" placeholder="å®é™…å®Œæˆ" min="0" step="1">
                    <div class="rate-tag" id="mainPushRateTag">è¾¾æˆç‡ï¼š--%</div>
                </div>
                <div class="error-tip" id="mainPushError">è¯·å¡«å†™ä¸»æ¨çš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ</div>
            </div>

            <div class="form-group">
                <label>é”€å”®é¢ï¼ˆå æ¯”30%ï¼‰<span style="color: #e53e3e;">*</span></label>
                <div class="input-group">
                    <input type="number" id="salesTarget" placeholder="ä»»åŠ¡ç›®æ ‡" min="1" step="1">
                    <input type="number" id="salesActual" placeholder="å®é™…å®Œæˆ" min="0" step="1">
                    <div class="rate-tag" id="salesRateTag">è¾¾æˆç‡ï¼š--%</div>
                </div>
                <div class="error-tip" id="salesError">è¯·å¡«å†™é”€å”®é¢çš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ</div>
            </div>

            <div class="form-group">
                <label>éæ‰‹æœºï¼ˆå æ¯”10%ï¼‰<span style="color: #e53e3e;">*</span></label>
                <div class="input-group">
                    <input type="number" id="nonPhoneTarget" placeholder="ä»»åŠ¡ç›®æ ‡" min="1" step="1">
                    <input type="number" id="nonPhoneActual" placeholder="å®é™…å®Œæˆ" min="0" step="1">
                    <div class="rate-tag" id="nonPhoneRateTag">è¾¾æˆç‡ï¼š--%</div>
                </div>
                <div class="error-tip" id="nonPhoneError">è¯·å¡«å†™éæ‰‹æœºçš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ</div>
            </div>

            <div class="form-group">
                <label>DSRï¼ˆå æ¯”10%ï¼‰<span style="color: #e53e3e;">*</span></label>
                <div class="input-group">
                    <input type="number" id="dsrTarget" placeholder="ä»»åŠ¡ç›®æ ‡ï¼ˆå¦‚95ï¼‰" min="1" step="0.1">
                    <input type="number" id="dsrActual" placeholder="å®é™…å®Œæˆï¼ˆå¦‚96ï¼‰" min="0" step="0.1">
                    <div class="rate-tag" id="dsrRateTag">è¾¾æˆç‡ï¼š--%</div>
                </div>
                <div class="error-tip" id="dsrError">è¯·å¡«å†™DSRçš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ</div>
            </div>

            <div class="form-group">
                <label>DOSï¼ˆå æ¯”10%ï¼‰<span style="color: #e53e3e;">*</span></label>
                <div class="input-group">
                    <input type="number" id="dosTarget" placeholder="ä»»åŠ¡ç›®æ ‡ï¼ˆå¦‚90ï¼‰" min="1" step="0.1">
                    <input type="number" id="dosActual" placeholder="å®é™…å®Œæˆï¼ˆå¦‚92ï¼‰" min="0" step="0.1">
                    <div class="rate-tag" id="dosRateTag">è¾¾æˆç‡ï¼š--%</div>
                </div>
                <div class="error-tip" id="dosError">è¯·å¡«å†™DOSçš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ</div>
            </div>
        </div>

        <div class="gap-calculator">
            <h3>
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                70%ç»¼åˆè¾¾æˆç‡ç¼ºå£è®¡ç®—ï¼ˆå¡«å†™å³æ˜¾ç»“æœï¼‰
            </h3>
            <div class="gap-summary" id="gapSummary">
                è¯·å¡«å†™è‡³å°‘1ä¸ªæ¿å—çš„ç›®æ ‡å’Œå®é™…å®Œæˆï¼Œç¼ºå£è‡ªåŠ¨è®¡ç®—
            </div>

            <div class="gap-items-container">
                <div class="gap-item">
                    <h4>æ–¹æ¡ˆ1ï¼šä»…æå‡ã€Œä¸»æ¨ã€</h4>
                    <div class="gap-detail" id="mainPushGap">
                        å¾…è¡¥å……ä¸»æ¨çš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ
                    </div>
                    <div class="gap-tip" id="mainPushGapTip"></div>
                </div>

                <div class="gap-item">
                    <h4>æ–¹æ¡ˆ2ï¼šä»…æå‡ã€Œé”€å”®é¢ã€</h4>
                    <div class="gap-detail" id="salesGap">
                        å¾…è¡¥å……é”€å”®é¢çš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ
                    </div>
                    <div class="gap-tip" id="salesGapTip"></div>
                </div>

                <div class="gap-item">
                    <h4>æ–¹æ¡ˆ3ï¼šä»…æå‡ã€Œéæ‰‹æœºã€</h4>
                    <div class="gap-detail" id="nonPhoneGap">
                        å¾…è¡¥å……éæ‰‹æœºçš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ
                    </div>
                    <div class="gap-tip" id="nonPhoneGapTip"></div>
                </div>

                <div class="gap-item">
                    <h4>æ–¹æ¡ˆ4ï¼šä»…æå‡ã€ŒDSRã€</h4>
                    <div class="gap-detail" id="dsrGap">
                        å¾…è¡¥å……DSRçš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ
                    </div>
                    <div class="gap-tip" id="dsrGapTip"></div>
                </div>

                <div class="gap-item">
                    <h4>æ–¹æ¡ˆ5ï¼šä»…æå‡ã€ŒDOSã€</h4>
                    <div class="gap-detail" id="dosGap">
                        å¾…è¡¥å……DOSçš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ
                    </div>
                    <div class="gap-tip" id="dosGapTip"></div>
                </div>
            </div>
        </div>

        <div class="fixed-item">
            <h3>ğŸ“Š è®¡ç®—æ˜ç»†</h3>
            <div class="fixed-row">
                <div class="fixed-label">ç»©æ•ˆåŸºæ•°ï¼ˆåŸºæœ¬å·¥èµ„Ã—50%ï¼‰</div>
                <div class="fixed-value" id="performanceBase">Â¥ 0.00</div>
            </div>
            <div class="fixed-row">
                <div class="fixed-label">ç»¼åˆè¾¾æˆç‡ï¼ˆå·²å°é¡¶å¤„ç†ï¼‰</div>
                <div class="fixed-value" id="totalRate">--%</div>
            </div>
            <div class="fixed-row">
                <div class="fixed-label">å®é™…ç»©æ•ˆï¼ˆå«1.2å€ä¸Šæµ®ï¼‰</div>
                <div class="fixed-value">
                    <span id="actualPerformance">Â¥ 0.00</span>
                    <span class="performance-status" id="performanceStatus"></span>
                </div>
            </div>
            <div class="fixed-row">
                <div class="fixed-label">é¤è¡¥ï¼ˆå›ºå®šï¼‰</div>
                <div class="fixed-value" id="mealSubsidy">Â¥ 695.00</div>
            </div>
        </div>

        <div class="calc-status" id="calcStatus">è®¡ç®—ä¸­...</div>

        <div class="btn-group">
            <button id="calcBtn">è®¡ç®—æœ€ç»ˆå·¥èµ„</button>
            <button id="resetBtn">é‡ç½®æ‰€æœ‰è¾“å…¥</button>
        </div>

        <div class="result">
            <h2>æœ€ç»ˆå·¥èµ„</h2>
            <div id="resultValue">Â¥ 0.00</div>
            <button class="copy-btn" id="copyResult">å¤åˆ¶ç»“æœ</button>
        </div>

        <div class="history">
            <h3>å†å²è®¡ç®—è®°å½•ï¼ˆç‚¹å‡»æŸæ¡å¯æ¢å¤æ•°æ®ï¼‰</h3>
            <div id="historyList"></div>
            <button id="clearHistory">æ¸…ç©ºå†å²è®°å½•</button>
        </div>

        <p class="tip">æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼Œéšç§å®‰å…¨ | è®¡ç®—æŒ‰é’®100%ç”Ÿæ•ˆ | ç‚¹å‡»å†å²è®°å½•å¯ä¸€é”®å¡«å…¥</p>
    </div>

    <script>
        // å·¥å…·å‡½æ•°ï¼šè·å–è¾“å…¥å€¼ï¼ˆé»˜è®¤0ï¼Œç¡®ä¿æ˜¯æ•°å­—ï¼‰
        function getInputVal(id) {
            const element = document.getElementById(id);
            if (!element) return 0; // é˜²æ­¢æ‰¾ä¸åˆ°å…ƒç´ æŠ¥é”™
            const val = element.value.trim();
            return val ? Number(val) : 0;
        }

        // è®¡ç®—å•ä¸ªæ¿å—çš„è¾¾æˆç‡ï¼ˆè¿”å›ï¼šè¾¾æˆç‡ã€ç›®æ ‡ã€å®é™…ï¼‰
        function calcSingleRate(targetId, actualId, tagId) {
            const target = getInputVal(targetId);
            const actual = getInputVal(actualId);
            let rate = 0;
            if (target > 0) {
                rate = (actual / target) * 100;
                rate = Math.min(rate, 130); // å°é¡¶130%
            }
            // æ›´æ–°è¾¾æˆç‡æ ‡ç­¾
            const tagEl = document.getElementById(tagId);
            if(tagEl) tagEl.textContent = `è¾¾æˆç‡ï¼š${rate.toFixed(1)}%`;
            return { rate, target, actual };
        }

        // è®¡ç®—å½“å‰ç»¼åˆè¾¾æˆç‡ï¼ˆç”¨äºæ±‡æ€»æ˜¾ç¤ºï¼‰
        function calcTotalRate() {
            const { rate: mainPushRate } = calcSingleRate('mainPushTarget', 'mainPushActual', 'mainPushRateTag');
            const { rate: salesRate } = calcSingleRate('salesTarget', 'salesActual', 'salesRateTag');
            const { rate: nonPhoneRate } = calcSingleRate('nonPhoneTarget', 'nonPhoneActual', 'nonPhoneRateTag');
            const { rate: dsrRate } = calcSingleRate('dsrTarget', 'dsrActual', 'dsrRateTag');
            const { rate: dosRate } = calcSingleRate('dosTarget', 'dosActual', 'dosRateTag');
            
            return (mainPushRate * 0.4) + (salesRate * 0.3) + (nonPhoneRate * 0.1) + (dsrRate * 0.1) + (dosRate * 0.1);
        }

        // è®¡ç®—å•ä¸ªæ¿å—çš„ç¼ºå£ï¼ˆç‹¬ç«‹è®¡ç®—ï¼Œäº’ä¸å½±å“ï¼‰
        function calcSingleGap(module, targetId, actualId, gapId, tipId) {
            const { rate: currentRate, target, actual } = calcSingleRate(targetId, actualId, `${module}RateTag`);
            const otherRates = {};
            // è·å–å…¶ä»–æ¿å—çš„è¾¾æˆç‡ç”¨äºåæ¨
            const modules = ['mainPush', 'sales', 'nonPhone', 'dsr', 'dos'];
            modules.forEach(m => {
                if(m !== module) {
                    otherRates[m] = calcSingleRate(`${m}Target`, `${m}Actual`, `${m}RateTag`).rate;
                }
            });

            const totalRate = calcTotalRate();
            const gapDetailEl = document.getElementById(gapId);
            const gapTipEl = document.getElementById(tipId);
            const weightMap = { mainPush: 0.4, sales: 0.3, nonPhone: 0.1, dsr: 0.1, dos: 0.1 };
            const weight = weightMap[module];

            if (target <= 0) {
                gapDetailEl.innerHTML = `å¾…è¡¥å……ä»»åŠ¡ç›®æ ‡`;
                gapTipEl.textContent = '';
                return;
            }

            // åæ¨é€»è¾‘
            let otherSum = 0;
            modules.forEach(m => {
                if(m !== module) otherSum += (otherRates[m] || 0) * weightMap[m];
            });

            let needRate = (70 - otherSum) / weight;
            needRate = Math.min(needRate, 130);
            needRate = Math.max(needRate, 0);

            const needActual = (needRate / 100) * target;
            const gap = Math.max(0, needActual - actual);
            
            const isFloat = module === 'dsr' || module === 'dos';
            const actualFormatted = actual.toFixed(isFloat ? 1 : 0);
            const needActualFormatted = needActual.toFixed(isFloat ? 1 : 0);
            const gapFormatted = gap.toFixed(isFloat ? 1 : 0);
            const unit = isFloat ? '' : 'å…ƒ';

            if (totalRate >= 70) {
                gapDetailEl.innerHTML = `å½“å‰å·²è¾¾æ ‡70%ï¼Œæ— éœ€è¡¥å……ï¼`;
                gapTipEl.textContent = `å½“å‰ç»¼åˆè¾¾æˆç‡ï¼š${totalRate.toFixed(1)}%`;
            } else if (needRate <= currentRate) {
                gapDetailEl.innerHTML = `å½“å‰è¾¾æˆç‡å·²è¶³å¤Ÿï¼Œæ— éœ€è¡¥å……ï¼`;
                gapTipEl.textContent = `å½“å‰è¾¾æˆç‡ï¼š${currentRate.toFixed(1)}%`;
            } else {
                gapDetailEl.innerHTML = `éœ€è¡¥å……ï¼š<span class="gap-number">${gapFormatted}${unit}</span>ï¼ˆå½“å‰${actualFormatted}${unit}ï¼Œéœ€${needActualFormatted}${unit}ï¼‰`;
                gapTipEl.textContent = `éœ€è¾¾æˆç‡ï¼š${needRate.toFixed(1)}%ï¼ˆå½“å‰ï¼š${currentRate.toFixed(1)}%ï¼‰`;
            }
        }

        // æ‰¹é‡è®¡ç®—æ‰€æœ‰æ¿å—ç¼ºå£
        function calculateAllGaps() {
            calcSingleGap('mainPush', 'mainPushTarget', 'mainPushActual', 'mainPushGap', 'mainPushGapTip');
            calcSingleGap('sales', 'salesTarget', 'salesActual', 'salesGap', 'salesGapTip');
            calcSingleGap('nonPhone', 'nonPhoneTarget', 'nonPhoneActual', 'nonPhoneGap', 'nonPhoneGapTip');
            calcSingleGap('dsr', 'dsrTarget', 'dsrActual', 'dsrGap', 'dsrGapTip');
            calcSingleGap('dos', 'dosTarget', 'dosActual', 'dosGap', 'dosGapTip');

            const totalRate = calcTotalRate();
            const rateGap = Math.max(0, 70 - totalRate);
            const gapSummary = document.getElementById('gapSummary');
            if (totalRate >= 70) {
                gapSummary.innerHTML = `å½“å‰ç»¼åˆè¾¾æˆç‡ï¼š<span class="gap-success">${totalRate.toFixed(1)}%</span>ï¼Œå·²è¾¾åˆ°70%é—¨æ§›ï¼Œå¯æ‹¿ç»©æ•ˆï¼`;
            } else {
                gapSummary.innerHTML = `å½“å‰ç»¼åˆè¾¾æˆç‡ï¼š<span>${totalRate.toFixed(1)}%</span>ï¼Œè·ç¦»70%é—¨æ§›è¿˜å·®ï¼š<span>${rateGap.toFixed(1)}%</span>`;
            }

            const baseSalary = getInputVal('baseSalary');
            document.getElementById('performanceBase').textContent = `Â¥ ${(baseSalary * 0.5).toFixed(2)}`;
        }

        function checkMissingInputs() {
            const missing = [];
            const baseSalary = getInputVal('baseSalary');
            if (baseSalary <= 0) missing.push('åŸºæœ¬å·¥èµ„');
            return missing;
        }

        // å†å²è®°å½•ç›¸å…³
        function getHistory() {
            try {
                return JSON.parse(localStorage.getItem('salaryCalcHistory')) || [];
            } catch(e) { return []; }
        }

        function saveHistory(record) {
            const history = getHistory();
            history.unshift(record);
            if (history.length > 20) history.pop();
            localStorage.setItem('salaryCalcHistory', JSON.stringify(history));
            renderHistory();
        }

        // æ ¸å¿ƒä¿®æ”¹ï¼šæ¸²æŸ“å†å²è®°å½•ï¼ˆå¢åŠ ç‚¹å‡»äº‹ä»¶ï¼‰
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const history = getHistory();
            if (history.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: #718096; font-size: 14px;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item" onclick="restoreHistory(${index})" title="ç‚¹å‡»æ¢å¤æ­¤æ•°æ®">
                    <div class="history-header">
                        <span>${item.time}</span>
                        <span>Â¥${item.finalSalary}</span>
                    </div>
                    <div class="history-detail">
                        åŸºæœ¬å·¥èµ„ï¼š${item.baseSalary}å…ƒ | ç»¼åˆè¾¾æˆç‡ï¼š${item.totalRate}% | 
                        ç»©æ•ˆï¼š${item.actualPerformance}å…ƒ
                    </div>
                </div>
            `).join('');
        }

        // æ–°å¢ï¼šæ¢å¤å†å²è®°å½•å‡½æ•°
        window.restoreHistory = function(index) {
            const history = getHistory();
            const record = history[index];
            if (!record || !record.inputData) {
                alert('è¯¥æ¡è®°å½•æ ¼å¼è¾ƒæ—§æˆ–å·²æŸåï¼Œæ— æ³•å®Œå…¨æ¢å¤ã€‚');
                return;
            }

            if (confirm(`æ˜¯å¦ç¡®è®¤å°†æ•°æ®æ¢å¤åˆ°ï¼š${record.time} çš„çŠ¶æ€ï¼Ÿ\nè¿™å°†è¦†ç›–å½“å‰è¾“å…¥æ¡†ä¸­çš„å†…å®¹ã€‚`)) {
                // å›å¡«æ•°æ®
                const data = record.inputData;
                
                // è®¾ç½®æ¯ä¸ªè¾“å…¥æ¡†çš„å€¼ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä¸ºç©ºï¼‰
                document.getElementById('baseSalary').value = data.baseSalary || '';
                
                document.getElementById('mainPushTarget').value = data.mainPushTarget || '';
                document.getElementById('mainPushActual').value = data.mainPushActual || '';
                
                document.getElementById('salesTarget').value = data.salesTarget || '';
                document.getElementById('salesActual').value = data.salesActual || '';
                
                document.getElementById('nonPhoneTarget').value = data.nonPhoneTarget || '';
                document.getElementById('nonPhoneActual').value = data.nonPhoneActual || '';
                
                document.getElementById('dsrTarget').value = data.dsrTarget || '';
                document.getElementById('dsrActual').value = data.dsrActual || '';
                
                document.getElementById('dosTarget').value = data.dosTarget || '';
                document.getElementById('dosActual').value = data.dosActual || '';

                // è§¦å‘ä¸€æ¬¡è®¡ç®—ä»¥æ›´æ–°UIçŠ¶æ€ï¼ˆç¼ºå£ã€è¾¾æˆç‡ç­‰ï¼‰
                calculateAllGaps();
                
                // æ»šåŠ¨åˆ°é¡¶éƒ¨
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        function copyText(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('å¤åˆ¶æˆåŠŸï¼');
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            document.body.removeChild(textarea);
        }

        function calculateFinalSalary() {
            const calcStatusEl = document.getElementById('calcStatus');
            calcStatusEl.style.display = 'block';

            // 1. ä»…æ£€æŸ¥åŸºæœ¬å·¥èµ„
            const missing = checkMissingInputs();
            if (missing.length > 0) {
                calcStatusEl.style.display = 'none';
                alert(`è¯·å¡«å†™ï¼š${missing.join('ã€')}`);
                showError('baseSalary', 'baseSalaryError');
                return;
            }

            hideAllErrors();

            try {
                // 2. æ— è®ºå…¶ä»–é¡¹å¡«æ²¡å¡«ï¼Œå¼ºåˆ¶æ‰§è¡Œè®¡ç®—
                const totalRate = calcTotalRate();
                document.getElementById('totalRate').textContent = `${totalRate.toFixed(1)}%`;

                // 3. è®¡ç®—ç»©æ•ˆ
                const baseSalary = getInputVal('baseSalary');
                const performanceBase = baseSalary * 0.5;
                let actualPerformance = 0;
                let performanceStatus = '';

                if (totalRate < 70) {
                    actualPerformance = 0;
                    performanceStatus = '(æœªè¾¾70%ï¼Œæ— ç»©æ•ˆ)';
                } else if (totalRate < 100) {
                    actualPerformance = performanceBase * (totalRate / 100);
                    performanceStatus = `(è¾¾æˆ${totalRate.toFixed(1)}%ï¼ŒæŒ‰æ¯”ä¾‹å‘æ”¾)`;
                } else {
                    actualPerformance = performanceBase * 1.2;
                    performanceStatus = '(è¾¾æˆâ‰¥100%ï¼Œ1.2å€ç»©æ•ˆ)';
                }

                document.getElementById('actualPerformance').textContent = `Â¥ ${actualPerformance.toFixed(2)}`;
                document.getElementById('performanceStatus').textContent = performanceStatus;

                const mealSubsidy = 695;
                const finalSalary = baseSalary + actualPerformance + mealSubsidy;
                document.getElementById('resultValue').textContent = `Â¥ ${finalSalary.toFixed(2)}`;

                // 4. ä¿å­˜å†å²è®°å½•ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜æ‰€æœ‰è¾“å…¥å€¼ï¼‰
                const inputData = {
                    baseSalary: document.getElementById('baseSalary').value,
                    mainPushTarget: document.getElementById('mainPushTarget').value,
                    mainPushActual: document.getElementById('mainPushActual').value,
                    salesTarget: document.getElementById('salesTarget').value,
                    salesActual: document.getElementById('salesActual').value,
                    nonPhoneTarget: document.getElementById('nonPhoneTarget').value,
                    nonPhoneActual: document.getElementById('nonPhoneActual').value,
                    dsrTarget: document.getElementById('dsrTarget').value,
                    dsrActual: document.getElementById('dsrActual').value,
                    dosTarget: document.getElementById('dosTarget').value,
                    dosActual: document.getElementById('dosActual').value,
                };

                saveHistory({
                    time: new Date().toLocaleString(),
                    baseSalary: baseSalary,
                    totalRate: totalRate.toFixed(1),
                    actualPerformance: actualPerformance.toFixed(2),
                    finalSalary: finalSalary.toFixed(2),
                    inputData: inputData // ä¿å­˜è¯¦ç»†æ•°æ®
                });

                // 5. åˆ·æ–°ç¼ºå£æ–¹æ¡ˆ
                calculateAllGaps();

                calcStatusEl.style.display = 'none';
                
            } catch (error) {
                calcStatusEl.style.display = 'none';
                alert('è®¡ç®—å‡ºé”™ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°å­—æ˜¯å¦æ­£ç¡®');
                console.error(error);
            }
        }

        function showError(inputId, errorId) {
            document.getElementById(inputId).classList.add('error');
            document.getElementById(errorId).style.display = 'block';
        }

        function hideError(inputId, errorId) {
            document.getElementById(inputId).classList.remove('error');
            document.getElementById(errorId).style.display = 'none';
        }

        function hideAllErrors() {
            hideError('baseSalary', 'baseSalaryError');
            hideError('mainPushTarget', 'mainPushError');
            hideError('salesTarget', 'salesError');
            hideError('nonPhoneTarget', 'nonPhoneError');
            hideError('dsrTarget', 'dsrError');
            hideError('dosTarget', 'dosError');
        }

        function resetAll() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.value = '');

            document.getElementById('mainPushRateTag').textContent = 'è¾¾æˆç‡ï¼š--%';
            document.getElementById('salesRateTag').textContent = 'è¾¾æˆç‡ï¼š--%';
            document.getElementById('nonPhoneRateTag').textContent = 'è¾¾æˆç‡ï¼š--%';
            document.getElementById('dsrRateTag').textContent = 'è¾¾æˆç‡ï¼š--%';
            document.getElementById('dosRateTag').textContent = 'è¾¾æˆç‡ï¼š--%';

            document.getElementById('performanceBase').textContent = 'Â¥ 0.00';
            document.getElementById('totalRate').textContent = '--%';
            document.getElementById('actualPerformance').textContent = 'Â¥ 0.00';
            document.getElementById('performanceStatus').textContent = '';
            document.getElementById('resultValue').textContent = 'Â¥ 0.00';

            document.getElementById('gapSummary').innerHTML = 'è¯·å¡«å†™è‡³å°‘1ä¸ªæ¿å—çš„ç›®æ ‡å’Œå®é™…å®Œæˆï¼Œç¼ºå£è‡ªåŠ¨è®¡ç®—';
            
            // é‡ç½®ç¼ºå£æ–‡å­—
            const details = ['mainPush', 'sales', 'nonPhone', 'dsr', 'dos'];
            const names = ['ä¸»æ¨', 'é”€å”®é¢', 'éæ‰‹æœº', 'DSR', 'DOS'];
            details.forEach((d, i) => {
                document.getElementById(`${d}Gap`).innerHTML = `å¾…è¡¥å……${names[i]}çš„ä»»åŠ¡ç›®æ ‡å’Œå®é™…å®Œæˆ`;
                document.getElementById(`${d}GapTip`).textContent = '';
            });

            hideAllErrors();
            document.getElementById('calcStatus').style.display = 'none';
        }

        // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
        const inputIds = [
            'baseSalary', 'mainPushTarget', 'mainPushActual',
            'salesTarget', 'salesActual', 'nonPhoneTarget',
            'nonPhoneActual', 'dsrTarget', 'dsrActual',
            'dosTarget', 'dosActual'
        ];
        inputIds.forEach(id => {
            const input = document.getElementById(id);
            if(input) {
                input.addEventListener('input', calculateAllGaps);
                input.addEventListener('paste', calculateAllGaps);
                input.addEventListener('blur', calculateAllGaps);
            }
        });

        // é¡µé¢åŠ è½½é€»è¾‘
        window.onload = function() {
            renderHistory();
            calculateAllGaps();
        };

        document.getElementById('calcBtn').addEventListener('click', calculateFinalSalary);
        document.getElementById('resetBtn').addEventListener('click', resetAll);
        document.getElementById('copyResult').addEventListener('click', () => {
            const resultText = document.getElementById('resultValue').textContent.replace('Â¥ ', '');
            copyText(resultText);
        });
        document.getElementById('clearHistory').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('salaryCalcHistory');
                renderHistory();
            }
        });
    </script>
</body>
</html>
